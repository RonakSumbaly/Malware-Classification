import os
from config import conf
import csv
import sys

globalSectionDict = {}

# Calls the function countLines on all files of the directory
def getFile(dirName):
    for _, _, files in os.walk(dirName):
        for f in files:
            print f
            print countLines(os.path.join(dirName, f))


# Counts the number of lines in a file
def countLines(fileOpen):
    fileLines = fileOpen.readlines()
    return sum(1 for line in fileLines)


# Adds unique words with their counts to dictionary
def addToDictionary(dictionary, key):
    if dictionary.has_key(key):
        dictionary[key] += 1
    else:
        dictionary[key] = 1


# Counts unique sections
def countSections(fileName,env):
    sectionCountDict = {}
    fileAsmName = os.path.join(conf[env]['file_loc'],fileName)+ ".asm"
    fileAsmOpen = open(fileAsmName, "r")
    fileAsmOpen2 = open(fileAsmName, "r")
    fileByteName = os.path.join(conf[env]['file_loc'],fileName)+ ".bytes"
    fileByteOpen = open(fileByteName, "r")
    fileLines = fileAsmOpen2.readlines()

    testFeatures = []

    if env=="test":
        fieldNamesLoc = conf['sample']['file_loc'] + "/CSV Files/" + "train" + "FeatureName.csv"
        wr = csv.reader(open(fieldNamesLoc,'r'))
        for line in wr:
            testFeatures = line

    for eachLine in fileLines:
        if ":" in eachLine:
            if env=="test" and eachLine.split(":")[0] in testFeatures:
                addToDictionary(sectionCountDict, eachLine.split(":")[0])
            elif env=="train":
                addToDictionary(sectionCountDict, eachLine.split(":")[0])

    sectionCountDict["LOC-asm"] = countLines(fileAsmOpen)
    sectionCountDict["fileSize-asm"] = os.path.getsize(fileAsmName)
    sectionCountDict["LOC-byte"] = countLines(fileByteOpen)
    sectionCountDict["fileSize-byte"] = os.path.getsize(fileByteName)
    globalSectionDict[fileName] = sectionCountDict


# Creates csv from a dictionary
def createCsvFromDict(env):
    countFeatureLoc = conf['sample']['file_loc'] + "/CSV Files/" + env + "Feature2.csv"
    fieldNames = set()

    if env=="train":
        for value in globalSectionDict.values():
            fieldNames.update(value.keys())
        fieldNames = ['ID'] +list(fieldNames)
        fieldNamesLoc = conf['sample']['file_loc'] + "/CSV Files/" + env + "FeatureName.csv"
        wr = csv.writer(open(fieldNamesLoc,'w+'))
        wr.writerow(fieldNames)
    else:
        fieldNamesLoc = conf['sample']['file_loc'] + "/CSV Files/" + "train" + "FeatureName.csv"
        wr = csv.reader(open(fieldNamesLoc,'r'))
        for line in wr:
            fieldNames= line

    wr = csv.DictWriter(open(countFeatureLoc, 'w+'), fieldnames=fieldNames)
    wr.writeheader()

    for (key,value) in globalSectionDict.iteritems():
        countFeature = dict(zip(fieldNames, [0] * len(fieldNames)))
        countFeature.update({'ID': key})
        countFeature.update(value)
        wr.writerow(countFeature)

def main(env):
    print env
    csvReader = csv.DictReader(open(conf[env]['labels']), fieldnames=['Id','Class'])
    for eachRow in csvReader:
        if eachRow['Id']=='Id':
            continue
        countSections(eachRow['Id'],env)
    createCsvFromDict(env)

if __name__ == "__main__":
    main(sys.argv[1])
